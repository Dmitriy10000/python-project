<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Python web chat</title>
	<link rel="stylesheet" href="static/css/chat.css">
	<link rel="stylesheet" href="static/css/bootstrap-reboot.min.css">
</head>
<body>
	<div class="container">
		<div class="shell">
			<div class="sidebar">
				<div class="logo_shell">
					<div class="logo"><a href="#">CHATTY</a></div>

					<div class="us_logo">
						<img src="static/icons/us_logo.png" alt="">
					</div>
				</div>
				<div class="search_in_chat">
					<input type="text" name="search" id="globalSearchInput" oninput="globalSearch()" placeholder="Search for users and groups">
				</div>
				<div id="searchResults">
					<!-- Здесь будут отображаться результаты поиска -->
				</div>
			</div>
			<div class="header">
				<div class="header_name">Volodya</div>
			</div>
		</div>
	</div>
	<div class="footer_input">
		<div class="chat_input">
			<form>
				<input type="text" name="chat" placeholder="Type here">
				
				<button type="submit">Send</button>
			</form>
	</div>


	<script>
		var searchTimeout;
		function globalSearch() {
			clearTimeout(searchTimeout);
			searchTimeout = setTimeout(function () {
				var searchQuery = document.getElementById('globalSearchInput').value;
				
				// Очищаем предыдущие результаты поиска
				document.getElementById('searchResults').innerHTML = '';

				// Выполняем AJAX-запрос к серверу для глобального поиска
				// Не отправляем searchQuery если он пустой
				if (searchQuery == '') {
					return;
				}
				fetch('/global_user_search', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded',
					},
					body: new URLSearchParams({
						search_query: searchQuery,
					}),
				})
				.then(response => response.json())
				.then(data => {
					console.log('Success:', data);
					// Обрабатываем результаты поиска
					var resultsContainer = document.getElementById('searchResults');
					data.forEach(user => {
						// Сделать для каждого пользователя отображение в виде:
						// <div class="search_result">
						// 	<div class="us_logo">
						// 		<img src="static/icons/us_logo.png" alt="">
						// 	</div>
						// 	<div>Имя Фамилия</div>
						// 	<button>Add</button>
						// </div>
						var listItem = document.createElement('div');
						listItem.classList.add('search_result');
						listItem.innerHTML = `
							<div class="us_logo">
								<img src="static/icons/us_logo.png" alt="">
							</div>
							<div>${user.name} ${user.surname}</div>
						`;
						// <button id="add ${user.user_id}" class="add" onclick="addToFriendList(${user.user_id})">Add to friend list</button>
						// <button id="pm ${user.user_id}" class="pm" onclick="personalMessage(${user.user_id})">Personal message</button>
						if (user.is_friend == false) {
							listItem.innerHTML += `<button id="add ${user.user_id}" class="add" onclick="addToFriendList(${user.user_id})"><svg class="icon" width="2em" height="2em" viewBox="0 0 1000 1000" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  enable-background="new 0 0 1000 1000" xml:space="preserve"><g><g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"><path d="M2704.2,4987.1c-34.5-34.5-36.4-57.4-28.7-245.1c24.9-505.5,34.5-988,23-1020.6c-24.9-68.9-95.7-65.1-245.1,9.6c-130.2,65.1-139.8,67-183.8,38.3c-24.9-15.3-46-46-46-67c0-21.1,53.6-281.5,118.7-580.2l118.7-540l11.5-651l11.5-651l90-268.1c162.8-478.7,344.7-781.2,633.8-1058.9c86.2-82.4,222.1-191.5,304.4-243.2l149.4-93.8l-13.4-97.6c-5.7-51.7-15.3-101.5-19.1-107.2c-3.8-7.6-134-17.2-289.1-23c-162.7-5.8-327.4-23-388.7-40.2c-162.8-45.9-361.9-155.1-484.4-266.1c-151.3-137.9-1106.7-1401.6-1192.9-1577.8c-97.7-199.1-122.5-365.7-122.5-802.3c0-430.8,24.9-597.4,124.5-802.3c74.7-155.1,183.8-293,321.7-405.9c99.6-82.3,291-187.6,382.9-208.7l51.7-11.5v407.8c0,226,9.6,442.3,19.2,480.6c24.9,88.1,126.4,178.1,218.3,195.3c107.2,21.1,227.8-44.1,277.6-149.4c36.4-74.7,40.2-114.9,40.2-534.2V-4780h1876.4h1876.4v474.9c0,434.6,3.8,478.7,38.3,534.2c74.7,124.5,201,162.8,333.2,103.4c158.9-68.9,164.7-91.9,164.7-637.6V-4780l63.2,11.5c285.3,49.8,520.8,170.4,704.6,365.7c147.4,157,208.7,256.6,279.6,457.6c53.6,149.4,53.6,155.1,53.6,630c0,409.8-5.7,494-34.5,591.7c-51.7,164.7-132.1,314-243.2,453.8l-97.6,120.6l-329.4,1.9c-298.7,1.9-344.6,7.6-497.8,53.6c-698.9,214.5-1166.1,723.8-1319.3,1439.9c-40.2,189.6-28.7,562.9,21.1,765.9c49.8,195.3,155.1,432.7,264.2,597.4c164.7,248.9,497.8,536.1,752.5,647.2c47.9,21.1,91.9,46,99.6,57.4c7.6,9.6,15.3,394.4,13.4,852.1c0,917.2-9.6,1041.6-109.1,1250.3c-151.3,323.6-419.3,545.7-760.2,635.7c-91.9,23-250.8,28.7-871.2,30.6h-756.3l-170.4,220.2c-93.8,120.6-189.6,233.6-214.5,248.9c-57.4,38.3-113,9.6-151.3-78.5c-24.9-63.2-51.7-78.5-122.5-67c-15.3,1.9-122.5,82.3-239.3,180C2771.2,5052.2,2769.3,5052.2,2704.2,4987.1z"/><path d="M7154.1,1209.3c-93.8-34.5-160.8-90-206.8-174.2c-40.2-76.6-42.1-107.2-47.9-553.4l-7.7-472.9L6409.2,3c-474.8-5.7-484.4-5.7-551.4-51.7C5608.9-221,5645.3-575.2,5922.9-692c57.4-23,158.9-28.7,520.8-28.7h448l7.7-472.9c5.7-517,9.6-534.2,124.5-639.5c80.4-76.6,126.4-93.8,239.3-93.8c124.5,0,212.5,42.1,291.1,139.8l59.3,74.7l5.7,495.9l5.7,495.9h459.5c490.2,0,545.7,9.6,647.2,101.5c61.3,57.4,116.8,180,116.8,262.3c0,134-113,296.8-235.5,342.7c-32.6,13.4-237.4,21.1-520.8,21.1h-467.2l-5.7,494c-5.7,492.1-5.7,495.9-53.6,564.9c-55.5,82.3-208.7,166.6-294.9,164.7C7238.3,1230.4,7186.6,1220.8,7154.1,1209.3z"/></g></g></svg></button>`;
						}
						else if (user.is_invite_sent == true) {
							listItem.innerHTML += `<button id="add ${user.user_id}" class="cancel_request" onclick="cancelRequest(${user.user_id})"><svg width="25px" height="25px" viewBox="0 0 1024 1024" class="icon"  version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M704 288h-281.6l177.6-202.88a32 32 0 0 0-48.32-42.24l-224 256a30.08 30.08 0 0 0-2.24 3.84 32 32 0 0 0-2.88 4.16v1.92a32 32 0 0 0 0 5.12A32 32 0 0 0 320 320a32 32 0 0 0 0 4.8 32 32 0 0 0 0 5.12v1.92a32 32 0 0 0 2.88 4.16 30.08 30.08 0 0 0 2.24 3.84l224 256a32 32 0 1 0 48.32-42.24L422.4 352H704a224 224 0 0 1 224 224v128a224 224 0 0 1-224 224H320a232 232 0 0 1-28.16-1.6 32 32 0 0 0-35.84 27.84 32 32 0 0 0 27.84 35.52A295.04 295.04 0 0 0 320 992h384a288 288 0 0 0 288-288v-128a288 288 0 0 0-288-288zM103.04 760a32 32 0 0 0-62.08 16A289.92 289.92 0 0 0 140.16 928a32 32 0 0 0 40-49.92 225.6 225.6 0 0 1-77.12-118.08zM64 672a32 32 0 0 0 22.72-9.28 37.12 37.12 0 0 0 6.72-10.56A32 32 0 0 0 96 640a33.6 33.6 0 0 0-9.28-22.72 32 32 0 0 0-10.56-6.72 32 32 0 0 0-34.88 6.72A32 32 0 0 0 32 640a32 32 0 0 0 2.56 12.16 37.12 37.12 0 0 0 6.72 10.56A32 32 0 0 0 64 672z" /></svg></button>`;
						}
						else if (user.is_invite_received == true) {
							listItem.innerHTML += `<button id="add ${user.user_id}" class="accept_request" onclick="acceptRequest(${user.user_id})">Accept request</button>`;
						}
						listItem.innerHTML += `<button id="pm ${user.user_id}" class="pm" onclick="personalMessage(${user.user_id})">Personal message</button>`;
						resultsContainer.appendChild(listItem);
					});
				})
				.catch(error => console.error('Error:', error));
			}, 300);
		}
		function addToFriendList(user_id) {
			// Отправляем AJAX-запрос на добавление пользователя в друзья
			fetch('/add_friend', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded',
				},
				body: new URLSearchParams({
					request_type: 'add',
					user_id: user_id,
				}),
			})
			.then(response => response.json())
			.then(data => {
				console.log('Success:', data);
				// Если data.success не пустой, то значит запрос на добавление в друзья был успешно отправлен
				if (data.success != '') {
					// Меняем текст на кнопке и класс кнопки на "Cancel request"
					document.getElementById(`add ${user_id}`).innerHTML = 'Cancel request';
					document.getElementById(`add ${user_id}`).classList.remove('add');
					document.getElementById(`add ${user_id}`).classList.add('cancel_request');
					document.getElementById(`add ${user_id}`).setAttribute('onclick', `cancelRequest(${user_id})`);
				}
			})
		}
		function cancelRequest(user_id) {
			// Отправляем AJAX-запрос на отмену запроса на добавление пользователя в друзья
			fetch('/add_friend', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded',
				},
				body: new URLSearchParams({
					request_type: 'cancel',
					user_id: user_id,
				}),
			})
			.then(response => response.json())
			.then(data => {
				console.log('Success:', data);
				// Если data.success не пустой, то значит запрос на добавление в друзья был успешно отправлен
				if (data.success != '') {
					// Меняем текст на кнопке и класс кнопки на "Add to friend list"
					document.getElementById(`add ${user_id}`).innerHTML = 'Add to friend list';
					document.getElementById(`add ${user_id}`).classList.remove('cancel_request');
					document.getElementById(`add ${user_id}`).classList.add('add');
					document.getElementById(`add ${user_id}`).setAttribute('onclick', `addToFriendList(${user_id})`);
				}
			})
		}
		// function personalMessage() {
		// 	// Отправляем AJAX-запрос на добавление пользователя в друзья
		// 	fetch('/personal_message', {
		// 		method: 'POST',
		// 		headers: {
		// 			'Content-Type': 'application/x-www-form-urlencoded',
		// 		},
		// 		body: new URLSearchParams({
		// 			user_id: user_id,
		// 		}),
		// 	})
		// }
	</script>
</body>
</html>